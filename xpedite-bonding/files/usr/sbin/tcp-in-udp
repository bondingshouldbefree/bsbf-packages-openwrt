#!/bin/sh

if [ $# -ne 2 ] || { [ "$1" != "l2" ] && [ "$1" != "l3" ]; }; then
    echo "Usage: $0 <l2|l3> <interface>"
    exit 1
fi

SEC="tc"
if [ "$1" = "l3" ]; then
    SEC="tc_l3"
fi

IFACE="$2"
PROGRAMME=/usr/local/share/tcp-in-udp/tcp_in_udp_tc.o

ip link set "$IFACE" gso_max_segs 0 && \
tc qdisc del dev "$IFACE" clsact 2>/dev/null ; \
tc qdisc replace dev "$IFACE" clsact && \
tc filter add dev "$IFACE" egress handle 2 fw action goto chain 1 && \
tc filter add dev "$IFACE" egress chain 1 bpf object-file "$PROGRAMME" section "$SEC" action csum udp && \
tc filter add dev "$IFACE" ingress u32 match ip sport 31001 0xffff action goto chain 1 && \
tc filter add dev "$IFACE" ingress u32 match ip sport 31002 0xffff action goto chain 1 && \
tc filter add dev "$IFACE" ingress u32 match ip sport 31003 0xffff action goto chain 1 && \
tc filter add dev "$IFACE" ingress chain 1 bpf object-file "$PROGRAMME" section "$SEC" direct-action
